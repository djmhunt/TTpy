
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dataFitting &#8212; pyHPDM 0.9.9 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyHPDM 0.9.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for dataFitting</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:Author: Dominic Hunt</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fire</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">outputting</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">data</span>

<span class="kn">from</span> <span class="nn">fitAlgs.fitSims</span> <span class="kn">import</span> <span class="n">FitSim</span>
<span class="kn">from</span> <span class="nn">fitAlgs.fitAlg</span> <span class="kn">import</span> <span class="n">FitAlg</span>
<span class="kn">from</span> <span class="nn">modelGenerator</span> <span class="kn">import</span> <span class="n">ModelGen</span>


<div class="viewcode-block" id="LengthError"><a class="viewcode-back" href="../dataFitting.html#dataFitting.LengthError">[docs]</a><span class="k">class</span> <span class="nc">LengthError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="OrderError"><a class="viewcode-back" href="../dataFitting.html#dataFitting.OrderError">[docs]</a><span class="k">class</span> <span class="nc">OrderError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../dataFitting.html#dataFitting.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">data_folder</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
        <span class="n">data_format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span>
        <span class="n">data_file_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_file_terminal_ID</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">data_read_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_split_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_extra_processing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;QLearn&#39;</span><span class="p">,</span>
        <span class="n">model_changing_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_constant_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">participantID</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span>
        <span class="n">participant_choices</span><span class="o">=</span><span class="s1">&#39;Actions&#39;</span><span class="p">,</span>
        <span class="n">participant_rewards</span><span class="o">=</span><span class="s1">&#39;Rewards&#39;</span><span class="p">,</span>
        <span class="n">model_fit_value</span><span class="o">=</span><span class="s1">&#39;ActionProb&#39;</span><span class="p">,</span>
        <span class="n">fit_subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">task_stimuli</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">participant_action_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_method</span><span class="o">=</span><span class="s1">&#39;Evolutionary&#39;</span><span class="p">,</span>
        <span class="n">fit_method_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_measure</span><span class="o">=</span><span class="s1">&#39;-loge&#39;</span><span class="p">,</span>
        <span class="n">fit_measure_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_extra_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">participant_varying_model_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save_fitting_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">boundary_excess_cost_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span>
        <span class="n">numpy_error_level</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
        <span class="n">fit_float_error_response_value</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">1e100</span><span class="p">,</span>
        <span class="n">calculate_covariance</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A framework for fitting models to data for tasks, along with</span>
<span class="sd">    recording the data associated with the fits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_folder : string or list of strings, optional</span>
<span class="sd">        The folder where the data can be found. Default is the current folder.</span>
<span class="sd">    data_format : string, optional</span>
<span class="sd">        The file type of the data, from ``mat``, ``csv``, ``xlsx`` and ``pkl``. Default is ``csv``</span>
<span class="sd">    data_file_filter : callable, string, list of strings or None, optional</span>
<span class="sd">        A function to process the file names or a list of possible prefixes as strings or a single string.</span>
<span class="sd">        Default ``None``, no file names removed</span>
<span class="sd">    data_file_terminal_ID : bool, optional</span>
<span class="sd">        Is there an ID number at the end of the filename? If not then a more general search will be performed.</span>
<span class="sd">        Default ``True``</span>
<span class="sd">    data_read_options : dict, optional</span>
<span class="sd">        The keyword arguments for the data importing method chosen</span>
<span class="sd">    data_split_by : string or list of strings, optional</span>
<span class="sd">        If multiple participant datasets are in one file sheet, this specifies the column or columns that can</span>
<span class="sd">        distinguish and identify the rows for each participant. Default ``None``</span>
<span class="sd">    data_group_by : list of strings, optional</span>
<span class="sd">        A list of parts of filenames that are repeated across participants, identifying all the files that should</span>
<span class="sd">        be grouped together to form one participants data. The rest of the filename is assumed to identify the</span>
<span class="sd">        participant. Default is ``None``</span>
<span class="sd">    data_extra_processing : callable, optional</span>
<span class="sd">        A function that modifies the dictionary of data read for each participant in such that it is appropriate</span>
<span class="sd">        for fitting. Default is ``None``</span>
<span class="sd">    model_name : string, optional</span>
<span class="sd">        The name of the file where a model.modelTemplate.Model class can be found. Default ``QLearn``</span>
<span class="sd">    model_changing_properties : dictionary with values of tuple of two floats, optional</span>
<span class="sd">        Parameters are the options that you allow to vary across model fits. Each model parameter is specified as a</span>
<span class="sd">        dict key. The value is a tuple containing the upper and lower search bounds, e.g. ``alpha`` has the bounds</span>
<span class="sd">        (0, 1). Default ``None``</span>
<span class="sd">    model_constant_properties : dictionary of float, string or binary valued elements, optional</span>
<span class="sd">        These contain all the the model options that define the version</span>
<span class="sd">        of the model being studied. Default ``None``</span>
<span class="sd">    participantID : str, optional</span>
<span class="sd">        The key (label) used to identify each participant. Default ``Name``</span>
<span class="sd">    participant_choices : string, optional</span>
<span class="sd">        The participant data key of their action choices. Default ``&#39;Actions&#39;``</span>
<span class="sd">    participant_rewards : string, optional</span>
<span class="sd">        The participant data key of the participant reward data. Default ``&#39;Rewards&#39;``</span>
<span class="sd">    model_fit_value : string, optional</span>
<span class="sd">        The key to be compared in the model data. Default ``&#39;ActionProb&#39;``</span>
<span class="sd">    fit_subset : ``float(&#39;Nan&#39;)``, ``None``, ``&quot;rewarded&quot;``, ``&quot;unrewarded&quot;``, ``&quot;all&quot;`` or list of int, optional</span>
<span class="sd">        Describes which, if any, subset of trials will be used to evaluate the performance of the model.</span>
<span class="sd">        This can either be described as a list of trial numbers or, by passing</span>
<span class="sd">        - ``&quot;all&quot;`` for fitting all trials</span>
<span class="sd">        - ``float(&#39;Nan&#39;)`` or ``&quot;unrewarded&quot;`` for all those trials whose feedback was ``float(&#39;Nan&#39;)``</span>
<span class="sd">        - ``&quot;rewarded&quot;`` for those who had feedback that was not ``float(&#39;Nan&#39;)``</span>
<span class="sd">        Default ``None``, which means all trials will be used.</span>
<span class="sd">    task_stimuli : list of strings or None, optional</span>
<span class="sd">        The keys containing the observational parameters seen by the</span>
<span class="sd">        participant before taking a decision on an action. Default ``None``</span>
<span class="sd">    participant_action_options : string or list of strings or None or one element list with a list, optional</span>
<span class="sd">        If a string or list of strings these are treated as dict keys where the valid actions for each trial can</span>
<span class="sd">        be found. If None then all trials will use all available actions. If the list contains one list then it will</span>
<span class="sd">        be treated as a list of valid actions for each trialstep. Default ``&#39;None&#39;``</span>
<span class="sd">    fit_method : string, optional</span>
<span class="sd">        The fitting method to be used. The names accepted are those of the modules in the folder fitAlgs containing a</span>
<span class="sd">        FitAlg class. Default ``&#39;evolutionary&#39;``</span>
<span class="sd">    fit_method_args : dict, optional</span>
<span class="sd">        A dictionary of arguments specific to the fitting method. Default ``None``</span>
<span class="sd">    fit_measure : string, optional</span>
<span class="sd">        The name of the function used to calculate the quality of the fit.</span>
<span class="sd">        The value it returns provides the fitter with its fitting guide. Default ``-loge``</span>
<span class="sd">    fit_measure_args : dict, optional</span>
<span class="sd">        The parameters used to initialise fitMeasure and extraFitMeasures. Default ``None``</span>
<span class="sd">    fit_extra_measures : list of strings, optional</span>
<span class="sd">        List of fit measures not used to fit the model, but to provide more information. Any arguments needed for these</span>
<span class="sd">        measures should be placed in fitMeasureArgs. Default ``None``</span>
<span class="sd">    participant_varying_model_parameters : dict of string, optional</span>
<span class="sd">        A dictionary of model settings whose values should vary from participant to participant based on the</span>
<span class="sd">        values found in the imported participant data files. The key is the label given in the participant data file,</span>
<span class="sd">        as a string, and the value is the associated label in the model, also as a string. Default ``{}``</span>
<span class="sd">    label : string, optional</span>
<span class="sd">        The label for the data fitting. Default ``None`` will mean no data is saved to files.</span>
<span class="sd">    save_fitting_progress : bool, optional</span>
<span class="sd">        Specifies if the results from each iteration of the fitting process should be returned. Default ``False``</span>
<span class="sd">    config_file : string, optional</span>
<span class="sd">        The file name and path of a ``.yaml`` configuration file. Overrides all other parameters if found.</span>
<span class="sd">        Default ``None``</span>
<span class="sd">    output_path : string, optional</span>
<span class="sd">        The path that will be used for the run output. Default ``None``</span>
<span class="sd">    pickle : bool, optional</span>
<span class="sd">        If true the data for each model, and participant is recorded.</span>
<span class="sd">        Default is ``False``</span>
<span class="sd">    boundary_excess_cost_function : str or callable returning a function, optional</span>
<span class="sd">        The function is used to calculate the penalty for exceeding the boundaries.</span>
<span class="sd">        Default is ``boundFunc.scalarBound()``</span>
<span class="sd">    min_log_level : str, optional</span>
<span class="sd">        Defines the level of the log from (``DEBUG``, ``INFO``, ``WARNING``, ``ERROR``, ``CRITICAL``). Default ``INFO``</span>
<span class="sd">    numpy_error_level : {&#39;log&#39;, &#39;raise&#39;}</span>
<span class="sd">        Defines the response to numpy errors. Default ``log``. See numpy.seterr</span>
<span class="sd">    fit_float_error_response_value : float, optional</span>
<span class="sd">        If a floating point error occurs when running a fit the fitter function</span>
<span class="sd">        will return a value for each element of fpRespVal. Default is ``1/1e100`</span>
<span class="sd">    calculate_covariance : bool, optional</span>
<span class="sd">        Is the covariance calculated. Default ``False``</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    modelGenerator : The model factory</span>
<span class="sd">    outputting : The outputting functions</span>
<span class="sd">    fitAlgs.fitAlg.FitAlg : General class for a method of fitting data</span>
<span class="sd">    fitAlgs.fitSims.fitSim : General class for a method of simulating the fitting of data</span>
<span class="sd">    data.Data : Data import class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">participant_varying_model_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_changing_variables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_changing_variables</span> <span class="o">=</span> <span class="n">participant_varying_model_parameters</span>

    <span class="c1"># TODO : Validate model_changing_properties with the data and the model</span>
    <span class="n">participants</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_type</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
                                       <span class="n">folders</span><span class="o">=</span><span class="n">data_folder</span><span class="p">,</span>
                                       <span class="n">file_name_filter</span><span class="o">=</span><span class="n">data_file_filter</span><span class="p">,</span>
                                       <span class="n">terminal_ID</span><span class="o">=</span><span class="n">data_file_terminal_ID</span><span class="p">,</span>
                                       <span class="n">split_by</span><span class="o">=</span><span class="n">data_split_by</span><span class="p">,</span>
                                       <span class="n">participantID</span><span class="o">=</span><span class="n">participantID</span><span class="p">,</span>
                                       <span class="n">choices</span><span class="o">=</span><span class="n">participant_choices</span><span class="p">,</span>
                                       <span class="n">feedbacks</span><span class="o">=</span><span class="n">participant_rewards</span><span class="p">,</span>
                                       <span class="n">stimuli</span><span class="o">=</span><span class="n">task_stimuli</span><span class="p">,</span>
                                       <span class="n">action_options</span><span class="o">=</span><span class="n">participant_action_options</span><span class="p">,</span>
                                       <span class="n">group_by</span><span class="o">=</span><span class="n">data_group_by</span><span class="p">,</span>
                                       <span class="n">extra_processing</span><span class="o">=</span><span class="n">data_extra_processing</span><span class="p">,</span>
                                       <span class="n">data_read_options</span><span class="o">=</span><span class="n">data_read_options</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_changing_properties</span><span class="p">:</span>
        <span class="n">model_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model_changing_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">v2</span> <span class="o">&lt;</span> <span class="n">v1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">OrderError</span><span class="p">(</span><span class="s1">&#39;The bounds specified for model parameter ``</span><span class="si">{}</span><span class="s1">`` must have the lower bound first&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LengthError</span><span class="p">(</span><span class="s2">&quot;The parameter values for the ``model_changing_properties`` must be presented as a list of the maximum and minimum values. Review those of ``</span><span class="si">{}</span><span class="s2">``&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_parameters</span> <span class="o">=</span> <span class="n">model_changing_properties</span>

    <span class="n">models</span> <span class="o">=</span> <span class="n">ModelGen</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                      <span class="n">parameters</span><span class="o">=</span><span class="n">model_parameters</span><span class="p">,</span>
                      <span class="n">other_options</span><span class="o">=</span><span class="n">model_constant_properties</span><span class="p">)</span>

    <span class="n">model_simulator</span> <span class="o">=</span> <span class="n">FitSim</span><span class="p">(</span><span class="n">participant_choice_property</span><span class="o">=</span><span class="n">participants</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
                             <span class="n">participant_reward_property</span><span class="o">=</span><span class="n">participants</span><span class="o">.</span><span class="n">feedbacks</span><span class="p">,</span>
                             <span class="n">model_fitting_variable</span><span class="o">=</span><span class="n">model_fit_value</span><span class="p">,</span>
                             <span class="n">fit_subset</span><span class="o">=</span><span class="n">fit_subset</span><span class="p">,</span>
                             <span class="n">task_stimuli_property</span><span class="o">=</span><span class="n">participants</span><span class="o">.</span><span class="n">stimuli</span><span class="p">,</span>
                             <span class="n">action_options_property</span><span class="o">=</span><span class="n">participants</span><span class="o">.</span><span class="n">action_options</span><span class="p">,</span>
                             <span class="n">float_error_response_value</span><span class="o">=</span><span class="n">fit_float_error_response_value</span>
                             <span class="p">)</span>

    <span class="n">fitting_method</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="n">fit_method</span><span class="p">,</span>
                                      <span class="n">class_folder</span><span class="o">=</span><span class="s1">&#39;fitAlgs&#39;</span><span class="p">,</span>
                                      <span class="n">inherited_class</span><span class="o">=</span><span class="n">FitAlg</span><span class="p">,</span>
                                      <span class="n">excluded_files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;boundFunc&#39;</span><span class="p">,</span> <span class="s1">&#39;qualityFunc&#39;</span><span class="p">,</span> <span class="s1">&#39;fitSims&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">fit_method_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fit_method_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting_method</span><span class="p">(</span><span class="n">fit_sim</span><span class="o">=</span><span class="n">model_simulator</span><span class="p">,</span>
                            <span class="n">fit_measure</span><span class="o">=</span><span class="n">fit_measure</span><span class="p">,</span>
                            <span class="n">extra_fit_measures</span><span class="o">=</span><span class="n">fit_extra_measures</span><span class="p">,</span>
                            <span class="n">fit_measure_args</span><span class="o">=</span><span class="n">fit_measure_args</span><span class="p">,</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="n">model_changing_properties</span><span class="p">,</span>
                            <span class="n">boundary_excess_cost</span><span class="o">=</span><span class="n">boundary_excess_cost_function</span><span class="p">,</span>
                            <span class="n">calculate_covariance</span><span class="o">=</span><span class="n">calculate_covariance</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">fit_method_args</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">outputting</span><span class="o">.</span><span class="n">Saving</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_name_generator</span><span class="p">:</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fitting&#39;</span><span class="p">)</span>

        <span class="n">log_fitting_parameters</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Beginning the data fitting&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">model_ID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Initialise the stores of information</span>
        <span class="n">participant_fits</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># type: collections.defaultdict[Any, list]</span>

        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_parameter_variables</span><span class="p">,</span> <span class="n">model_static_args</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">iter_details</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_changing_variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model_static_args</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;Varies for each participant&gt;&quot;</span>

            <span class="n">log_model_fitting_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_parameter_variables</span><span class="p">,</span> <span class="n">model_static_args</span><span class="p">)</span>

            <span class="n">participantID</span> <span class="o">=</span> <span class="n">participants</span><span class="o">.</span><span class="n">participantID</span>
            <span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>

                <span class="n">participant_name</span> <span class="o">=</span> <span class="n">participant</span><span class="p">[</span><span class="n">participantID</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">participant_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">participant_name</span> <span class="o">=</span> <span class="n">participant_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_changing_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">model_static_args</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">participant</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="c1"># Find the best model values from those proposed</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Beginning participant fit for participant </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">participant_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="n">model_fitted</span><span class="p">,</span> <span class="n">fit_quality</span><span class="p">,</span> <span class="n">fitting_data</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">participant</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                                                             <span class="n">model_parameter_variables</span><span class="p">,</span>
                                                                             <span class="n">model_static_args</span><span class="p">,</span>
                                                                             <span class="n">participant</span><span class="p">)</span>

                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Participant fitted&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="n">log_model_fitted_parameters</span><span class="p">(</span><span class="n">model_parameter_variables</span><span class="p">,</span> <span class="n">model_fitted</span><span class="o">.</span><span class="n">params</span><span class="p">(),</span> <span class="n">fit_quality</span><span class="p">,</span> <span class="n">participant_name</span><span class="p">)</span>

                <span class="n">participant_fits</span> <span class="o">=</span> <span class="n">record_participant_fit</span><span class="p">(</span><span class="n">participant</span><span class="p">,</span> <span class="n">participant_name</span><span class="p">,</span> <span class="n">model_fitted</span><span class="o">.</span><span class="n">returnTaskState</span><span class="p">(),</span>
                                                          <span class="nb">str</span><span class="p">(</span><span class="n">model_ID</span><span class="p">),</span> <span class="n">fitting_data</span><span class="p">,</span> <span class="n">model_changing_variables</span><span class="p">,</span>
                                                          <span class="n">participant_fits</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="o">=</span><span class="n">file_name_generator</span><span class="p">,</span>
                                                          <span class="n">pickleData</span><span class="o">=</span><span class="n">pickle</span><span class="p">,</span> <span class="n">saveFittingProgress</span><span class="o">=</span><span class="n">save_fitting_progress</span><span class="p">)</span>

            <span class="n">model_ID</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">fit_record</span><span class="p">(</span><span class="n">participant_fits</span><span class="p">,</span> <span class="n">file_name_generator</span><span class="p">)</span></div>


<span class="c1"># %% Data record functions  </span>
<div class="viewcode-block" id="record_participant_fit"><a class="viewcode-back" href="../dataFitting.html#dataFitting.record_participant_fit">[docs]</a><span class="k">def</span> <span class="nf">record_participant_fit</span><span class="p">(</span><span class="n">participant</span><span class="p">,</span> <span class="n">part_name</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">fitting_data</span><span class="p">,</span> <span class="n">partModelVars</span><span class="p">,</span> <span class="n">participantFits</span><span class="p">,</span>
                           <span class="n">fileNameGen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickleData</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saveFittingProgress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expData</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Record the data relevant to the participant fitting</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    participant : dict</span>
<span class="sd">        The participant data</span>
<span class="sd">    part_name : int or string</span>
<span class="sd">        The identifier for each participant</span>
<span class="sd">    model_data : dict</span>
<span class="sd">        The data from the model</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The label given to the model</span>
<span class="sd">    fitting_data : dict</span>
<span class="sd">        Dictionary of details of the different fits, including an ordered dictionary containing the parameter values</span>
<span class="sd">        tested, in the order they were tested, and a list of the fit qualities of these parameters</span>
<span class="sd">    partModelVars : dict of string</span>
<span class="sd">        A dictionary of model settings whose values should vary from participant to participant based on the</span>
<span class="sd">        values found in the imported participant data files. The key is the label given in the participant data file,</span>
<span class="sd">        as a string, and the value is the associated label in the model, also as a string.</span>
<span class="sd">    participantFits : defaultdict of lists</span>
<span class="sd">        A dictionary to be filled with the summary of the participant fits</span>
<span class="sd">    fileNameGen : function or None</span>
<span class="sd">        Creates a new file with the name &lt;handle&gt; and the extension &lt;extension&gt;. It takes two string parameters: (``handle``, ``extension``) and</span>
<span class="sd">        returns one ``fileName`` string. Default ``None``</span>
<span class="sd">    pickleData : bool, optional</span>
<span class="sd">        If true the data for each model, task and participant is recorded.</span>
<span class="sd">        Default is ``False``</span>
<span class="sd">    saveFittingProgress : bool, optional</span>
<span class="sd">        Specifies if the results from each iteration of the fitting process should be returned. Default ``False``</span>
<span class="sd">    expData : dict, optional</span>
<span class="sd">        The data from the task. Default ``None``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    participantFits : defaultdict of lists</span>
<span class="sd">        A dictionary to be filled with the summary of the previous and current participant fits</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    outputting.pickleLog : records the picked data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Logging&#39;</span><span class="p">)</span>
    <span class="n">partNameStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part_name</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Recording participant &quot;</span> <span class="o">+</span> <span class="n">partNameStr</span> <span class="o">+</span> <span class="s2">&quot; model fit&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;_Model-&quot;</span> <span class="o">+</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_Part-&quot;</span> <span class="o">+</span> <span class="n">partNameStr</span>

    <span class="n">participantName</span> <span class="o">=</span> <span class="s2">&quot;Participant &quot;</span> <span class="o">+</span> <span class="n">partNameStr</span>

    <span class="n">participant</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">participantName</span><span class="p">)</span>
    <span class="n">participant</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;assigned_name&quot;</span><span class="p">,</span> <span class="n">participantName</span><span class="p">)</span>
    <span class="n">fitting_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">participantName</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileNameGen</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Store data for &quot;</span> <span class="o">+</span> <span class="n">participantName</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">participantFits</span> <span class="o">=</span> <span class="n">record_fitting</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">partModelVars</span><span class="p">,</span> <span class="n">participantFits</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="p">,</span>
                                         <span class="n">save_fitting_progress</span><span class="o">=</span><span class="n">saveFittingProgress</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pickleData</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outputting</span><span class="o">.</span><span class="n">pickleLog</span><span class="p">(</span><span class="n">expData</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="p">,</span> <span class="s2">&quot;_expData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">outputting</span><span class="o">.</span><span class="n">pickleLog</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="p">,</span> <span class="s2">&quot;_modelData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">outputting</span><span class="o">.</span><span class="n">pickleLog</span><span class="p">(</span><span class="n">participant</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="p">,</span> <span class="s2">&quot;_partData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">outputting</span><span class="o">.</span><span class="n">pickleLog</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">,</span> <span class="n">fileNameGen</span><span class="p">,</span> <span class="s2">&quot;_fitData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">participantFits</span></div>


<span class="c1"># %% Recording</span>
<div class="viewcode-block" id="record_fitting"><a class="viewcode-back" href="../dataFitting.html#dataFitting.record_fitting">[docs]</a><span class="k">def</span> <span class="nf">record_fitting</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">participant_model_variables</span><span class="p">,</span> <span class="n">participant_fits</span><span class="p">,</span> <span class="n">file_name_generator</span><span class="p">,</span>
                   <span class="n">save_fitting_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records formatted versions of the fitting data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitting_data : dict, optional</span>
<span class="sd">        Dictionary of details of the different fits, including an ordered dictionary containing the parameter values</span>
<span class="sd">        tested, in the order they were tested, and a list of the fit qualities of these parameters.</span>
<span class="sd">    label : str</span>
<span class="sd">        The label used to identify the fit in the file names</span>
<span class="sd">    participant : dict</span>
<span class="sd">        The participant data</span>
<span class="sd">    participant_model_variables : dict of string</span>
<span class="sd">        A dictionary of model settings whose values should vary from participant to participant based on the</span>
<span class="sd">        values found in the imported participant data files. The key is the label given in the participant data file,</span>
<span class="sd">        as a string, and the value is the associated label in the model, also as a string.</span>
<span class="sd">    participant_fits : defaultdict of lists</span>
<span class="sd">        A dictionary to be filled with the summary of the participant fits</span>
<span class="sd">    file_name_generator : function</span>
<span class="sd">        Creates a new file with the name &lt;handle&gt; and the extension &lt;extension&gt;. It takes two string parameters: (``handle``, ``extension``) and</span>
<span class="sd">        returns one ``fileName`` string</span>
<span class="sd">    save_fitting_progress : bool, optional</span>
<span class="sd">        Specifies if the results from each iteration of the fitting process should be returned. Default ``False``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    participant_fits : defaultdict of lists</span>
<span class="sd">        A dictionary to be filled with the summary of the previous and current participant fits</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extendedLabel</span> <span class="o">=</span> <span class="s2">&quot;ParameterFits&quot;</span> <span class="o">+</span> <span class="n">label</span>

    <span class="n">participant_fits</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">participant</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">])</span>
    <span class="n">participant_fits</span><span class="p">[</span><span class="s2">&quot;assigned_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">participant</span><span class="p">[</span><span class="s2">&quot;assigned_name&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;fit_quality&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">fitting_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">participant_fits</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fitting_data</span><span class="p">[</span><span class="s2">&quot;final_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">participant_fits</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">participant_model_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">participant_fits</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">participant</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">save_fitting_progress</span><span class="p">:</span>
        <span class="n">xlsx_fitting_data</span><span class="p">(</span><span class="n">fitting_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">extendedLabel</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">file_name_generator</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">participant_fits</span></div>


<span class="c1">#%% logging</span>
<div class="viewcode-block" id="log_model_fitting_parameters"><a class="viewcode-back" href="../dataFitting.html#dataFitting.log_model_fitting_parameters">[docs]</a><span class="k">def</span> <span class="nf">log_model_fitting_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_fit_variables</span><span class="p">,</span> <span class="n">model_other_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs the model and task parameters that used as initial fitting conditions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : string</span>
<span class="sd">        The name of the model</span>
<span class="sd">    model_fit_variables : dict</span>
<span class="sd">        The model parameters that will be fitted over and varied.</span>
<span class="sd">    model_other_args : dict</span>
<span class="sd">        The other parameters used in the model whose attributes have been</span>
<span class="sd">        modified by the user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">model_fit_variables</span><span class="p">)</span>
    <span class="n">model_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">model_other_args</span><span class="p">))</span>
    <span class="n">model_instance</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_args</span><span class="p">)</span>
    <span class="n">model_properties</span> <span class="o">=</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">params</span><span class="p">()</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;The fit will use the model ``</span><span class="si">{}</span><span class="s2">``&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_properties</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>

    <span class="n">modelFitParams</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39; around &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_fit_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; fitted with the parameters &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modelFitParams</span><span class="p">)</span>

    <span class="n">model_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]()</span><span class="si">{}</span><span class="s1">&lt;&gt;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_other_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                                               <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_fit_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; and using the other user specified parameters &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_parameters</span><span class="p">)</span>

    <span class="n">logger_sim</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fitting&#39;</span><span class="p">)</span>
    <span class="n">logger_sim</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="log_model_fitted_parameters"><a class="viewcode-back" href="../dataFitting.html#dataFitting.log_model_fitted_parameters">[docs]</a><span class="k">def</span> <span class="nf">log_model_fitted_parameters</span><span class="p">(</span><span class="n">model_fit_variables</span><span class="p">,</span> <span class="n">model_parameters</span><span class="p">,</span> <span class="n">fit_quality</span><span class="p">,</span> <span class="n">participant_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs the model and task parameters that used as initial fitting</span>
<span class="sd">    conditions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_fit_variables : dict</span>
<span class="sd">        The model parameters that have been fitted over and varied.</span>
<span class="sd">    model_parameters : dict</span>
<span class="sd">        The model parameters for the fitted model</span>
<span class="sd">    fit_quality : float</span>
<span class="sd">        The value of goodness of fit</span>
<span class="sd">    participant_name : int or string</span>
<span class="sd">        The identifier for each participant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_fit_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">model_fit_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]()&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;The fitted values for participant &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">participant_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; are &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_fit_parameters</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; with a fit quality of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fit_quality</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>

    <span class="n">logger_sim</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fitting&#39;</span><span class="p">)</span>
    <span class="n">logger_sim</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="log_fitting_parameters"><a class="viewcode-back" href="../dataFitting.html#dataFitting.log_fitting_parameters">[docs]</a><span class="k">def</span> <span class="nf">log_fitting_parameters</span><span class="p">(</span><span class="n">fit_info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records and outputs to the log the parameters associated with the fitting algorithms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fit_info : dict</span>
<span class="sd">        The details of the fitting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fitting&#39;</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fitting information:&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fit_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;For &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fit_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<span class="c1">#%% CSV</span>
<div class="viewcode-block" id="fit_record"><a class="viewcode-back" href="../dataFitting.html#dataFitting.fit_record">[docs]</a><span class="k">def</span> <span class="nf">fit_record</span><span class="p">(</span><span class="n">participant_fits</span><span class="p">,</span> <span class="n">file_name_generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the participant fits summary as a csv file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    participant_fits : dict</span>
<span class="sd">        A summary of the recovered parameters</span>
<span class="sd">    file_name_generator : function</span>
<span class="sd">        Creates a new file with the name &lt;handle&gt; and the extension &lt;extension&gt;. It takes two string parameters: (``handle``, ``extension``) and</span>
<span class="sd">        returns one ``fileName`` string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participant_fit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">participant_fits</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_name_generator</span><span class="p">(</span><span class="s2">&quot;participantFits&quot;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">)</span>
    <span class="n">participant_fit</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>


<span class="c1">#%% Excel</span>
<div class="viewcode-block" id="xlsx_fitting_data"><a class="viewcode-back" href="../dataFitting.html#dataFitting.xlsx_fitting_data">[docs]</a><span class="k">def</span> <span class="nf">xlsx_fitting_data</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">file_name_generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the fitting data to an XLSX file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitting_data : dict, optional</span>
<span class="sd">        Dictionary of details of the different fits, including an ordered dictionary containing the parameter values</span>
<span class="sd">        tested, in the order they were tested, and a list of the fit qualities of these parameters.</span>
<span class="sd">    label : str</span>
<span class="sd">        The label used to identify the fit in the file names</span>
<span class="sd">    participant : dict</span>
<span class="sd">        The participant data</span>
<span class="sd">    file_name_generator : function</span>
<span class="sd">        Creates a new file with the name &lt;handle&gt; and the extension &lt;extension&gt;. It takes two string parameters: (``handle``, ``extension``) and</span>
<span class="sd">        returns one ``fileName`` string</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">partData</span> <span class="o">=</span> <span class="n">outputting</span><span class="o">.</span><span class="n">newListDict</span><span class="p">(</span><span class="n">participant</span><span class="p">,</span> <span class="s1">&#39;part&#39;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">partData</span><span class="p">)</span>

    <span class="n">parameter_fitting_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">[</span><span class="s2">&quot;tested_parameters&quot;</span><span class="p">])</span>
    <span class="n">parameter_fitting_dict</span><span class="p">[</span><span class="s1">&#39;participant_fitting_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitting_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>
    <span class="c1">#parameter_fitting_dict[&#39;fit_quality&#39;] = fittingData.pop(&quot;fit_quality&quot;)</span>
    <span class="c1">#parameter_fitting_dict[&quot;fitQualities&quot;] = fittingData.pop(&quot;fitQualities&quot;)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fitting_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;final_parameters&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">parameter_fitting_dict</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;final&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">parameter_fitting_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fitting_data</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameter_fitting_dict</span><span class="p">)</span>
    <span class="n">record_data</span> <span class="o">=</span> <span class="n">outputting</span><span class="o">.</span><span class="n">newListDict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">record</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">record_data</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;data/&quot;</span> <span class="o">+</span> <span class="n">label</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_name_generator</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">)</span>
    <span class="n">xlsxT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">record</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">xlsxT</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;ParameterFits&#39;</span><span class="p">)</span>
    <span class="n">xlsxT</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyHPDM 0.9.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2020, Dominic Hunt.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>